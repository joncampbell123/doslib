
# TODO: OS/2 target: What can we #define to tell the header files which OS/2
#       environment we're doing? (Command prompt app. vs Presentation Manager app vs.
#       "fullscreen" app.)

# this makefile is included from all the dos*.mak files, do not use directly
# NTS: HPS is either \ (DOS) or / (Linux)

NOW_BUILDING = CXX

CFLAGS_THIS = -fr=nul -fo=$@ -i..

.C.OBJ:
        $(CC) $(CFLAGS_THIS) $(CFLAGS_CON) $[@
!ifdef TINYMODE
        $(OMFSEGDG) -i $@ -o $@
!endif

.CPP.OBJ:
        $(CXX) $(CFLAGS_THIS) $(CFLAGS_CON) $[@
!ifdef TINYMODE
        $(OMFSEGDG) -i $@ -o $@
!endif

.ASM.OBJ:
        nasm -o $@ -f obj $(NASMFLAGS) $[@
!ifdef TINYMODE
        $(OMFSEGDG) -i $@ -o $@
!endif

all: $(OMFSEGDG) lib exe

TEST_EXE =    $(SUBDIR)$(HPS)test.$(EXEEXT)

!ifdef TARGET_WINDOWS
!else
! ifdef TARGET_OS2
! else
8254_EXE =    $(SUBDIR)$(HPS)8254.$(EXEEXT)
! endif
!endif

exe: $(TEST_EXE) $(8254_EXE) .symbolic

lib: .symbolic

!ifdef TEST_EXE
$(TEST_EXE): $(HW_CPU_LIB) $(HW_CPU_LIB_DEPENDENCIES) $(HW_DOS_LIB) $(HW_DOS_LIB_DEPENDENCIES) $(SUBDIR)$(HPS)test.obj $(DOSNTAST_VDD)
        %write tmp.cmd option quiet system $(WLINK_CON_SYSTEM) $(WLINK_FLAGS) $(HW_CPU_LIB_WLINK_LIBRARIES) $(HW_DOS_LIB_WLINK_LIBRARIES) file $(SUBDIR)$(HPS)test.obj
        %write tmp.cmd option map=$(TEST_EXE).map
! ifdef TARGET_WINDOWS
!  ifeq TARGET_MSDOS 16
        %write tmp.cmd segment TYPE CODE PRELOAD MOVEABLE DISCARDABLE SHARED
        %write tmp.cmd segment TYPE DATA PRELOAD MOVEABLE DISCARDABLE
        # protected mode only. real-mode Windows is a pain.
        %append tmp.cmd option protmode
!  endif
! endif
        %write tmp.cmd name $(TEST_EXE)
        @*wlink @tmp.cmd
        @$(COPY) ..$(HPS)dos32a.dat $(SUBDIR)$(HPS)dos4gw.exe
! ifdef WIN386
        @$(WIN386_EXE_TO_REX_IF_REX) $(TEST_EXE)
        @wbind $(TEST_EXE) -q -n
! endif
! ifdef WIN_NE_SETVER_BUILD
        $(WIN_NE_SETVER_BUILD) $(TEST_EXE)
! endif
!endif

!ifdef 8254_EXE
$(8254_EXE): $(HW_8259_LIB) $(HW_8259_LIB_DEPENDENCIES) $(HW_8254_LIB) $(HW_8254_LIB_DEPENDENCIES) $(HW_CPU_LIB) $(HW_CPU_LIB_DEPENDENCIES) $(HW_DOS_LIB) $(HW_DOS_LIB_DEPENDENCIES) $(SUBDIR)$(HPS)8254.obj $(DOSNTAST_VDD)
        %write tmp.cmd option quiet system $(WLINK_CON_SYSTEM) $(WLINK_FLAGS) $(HW_8259_LIB_WLINK_LIBRARIES) $(HW_8254_LIB_WLINK_LIBRARIES) $(HW_CPU_LIB_WLINK_LIBRARIES) $(HW_DOS_LIB_WLINK_LIBRARIES) file $(SUBDIR)$(HPS)8254.obj
        %write tmp.cmd option map=$(8254_EXE).map
! ifdef TARGET_WINDOWS
!  ifeq TARGET_MSDOS 16
        %write tmp.cmd segment TYPE CODE PRELOAD MOVEABLE DISCARDABLE SHARED
        %write tmp.cmd segment TYPE DATA PRELOAD MOVEABLE DISCARDABLE
        # protected mode only. real-mode Windows is a pain.
        %append tmp.cmd option protmode
!  endif
! endif
        *wlink @tmp.cmd name $(8254_EXE)
        @$(COPY) ..$(HPS)dos32a.dat $(SUBDIR)$(HPS)dos4gw.exe
! ifdef WIN386
        @$(WIN386_EXE_TO_REX_IF_REX) $(8254_EXE)
        @wbind $(8254_EXE) -q -n
! endif
! ifdef WIN_NE_SETVER_BUILD
        $(WIN_NE_SETVER_BUILD) $(8254_EXE)
! endif
!endif

clean: .SYMBOLIC
          del $(SUBDIR)$(HPS)*.obj
          del $(HW_DOS_LIB)
          del tmp.cmd
          @echo Cleaning done

